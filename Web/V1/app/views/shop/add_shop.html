<title><{translate('店舗管理')}> - <{translate('店舗追加')}> </title>
<div class="page-header">
	<h1>
		<{translate('店舗管理')}> <small> <i class="ace-icon fa fa-angle-double-right"></i> <{translate('店舗追加')}>
		</small>
	</h1>
</div>
<!-- /.page-header -->
	<script>window.UEDITOR_HOME_URL = '/app/third_party/ueditor1_4_3_3-utf8-php/';</script>
    <script type="text/javascript" charset="utf-8" src="/app/third_party/ueditor1_4_3_3-utf8-php/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="/app/third_party/ueditor1_4_3_3-utf8-php/ueditor.all.min.js"> </script>
<!--<script type="text/javascript" charset="utf-8" src="/app/third_party/ueditor1_4_3_3-utf8-php/lang/en/en.js"></script>-->
<script type="text/javascript" charset="utf-8" src="/app/third_party/ueditor1_4_3_3-utf8-php/lang/en/en.js"></script>
	<script type="text/plain" id="j_ueditorupload" style="height:5px;display:none;" ></script>
    <script type="text/javascript" charset="utf-8" src="/app/third_party/ueditor1_4_3_3-utf8-php/ueditor.upload.js"></script>
	<script type="text/javascript" src="/style/js/cnarealist.js"></script>    
	<script type="text/javascript" src="/style/js/categorys/categorys.js"></script>    
    <link rel="stylesheet" href="/style/js/categorys/categorys.css" />
<script language='javascript' src="/style/assets/js/jquery.dialogBox.js"></script>
<link rel="stylesheet" href="/style/assets/js/jquery.dialogbox.css" />

<div class="row">
	<div class="col-md-12">
<div class="main">
    <ul class="nav nav-tabs">
    	<{if chkcommand('/admin_shop')}>
        <li><a href="/admin_system#page/admin_shop/"><{translate('加盟店リスト')}></a></li>
        <{/if}>
        <li class="active"><a href="/admin_system#page/admin_shop/add/<{$data->id}>"><{translate('店舗追加')}></a></li>
    </ul>
    
  <div class="panel panel-default">
        <div class="panel-body table-responsive">

			<form class="form-horizontal" method="post" role="form" id="submitform"  >

				<div class="panel panel-info">
			<div class="panel-heading">
				<{translate('アカウント情報')}>
			</div>
		</div>

		<input type="hidden" name="gid" value="4">
		<input type="hidden" name="status" value="1">

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('ユーザー名')}>*:</label>
			<div class="col-xs-12 col-sm-4">
				<span class="block">
					<input id="adminname" type="text" name="adminname" class="form-control input-width" autocomplete="new-password"  maxlength="100" required />
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>
	
		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('パスワード')}>*:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="password" type="password" name="password" class="form-control input-width" autocomplete="new-password" maxlength="100"  required/>
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('パスワード確認')}>*:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="repasswd" type="password" name="repasswd" class="form-control input-width" autocomplete="new-password" maxlength="100"  required/>
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>
    
		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('休業日')}>:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<{foreach $week as $k=>$v}>
					<input type="checkbox" name="week<{$k}>" value="1"  <{if $data->week[$k]==1}>checked="checked"<{/if}> /><{$v}>
					<{/foreach}>
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('本部手数料')}>(<b style="color:red;">%</b>):</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="percen" type="text" name="percen" value="<{$data->percen}>" max="100" min="0" class="form-control input-width" />
				</span>
			</div>
			<div class="help-block inline"><b id="limit-percen"></b> </div>
		</div>

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right" ><{translate('営業開始')}>:</label>
			<div class="col-xs-12 col-sm-2">
				<span class="block input-icon input-icon-right">
					<input id="hours" type="text" name="hours" value="<{$data->hours}>" class="form-control input-width"   required/>
					<i class="ace-icon fa fa-clock-o green"></i>
				</span>
			</div>
			<label for="title" class="col-xs-12 col-sm-1 control-label no-padding-right" style="white-space: nowrap;"><{translate('閉店時間')}>:</label>
			<div class="col-xs-12 col-sm-2">
				<span class="block input-icon input-icon-right">
					<input id="hours1" type="text" name="hours1" value="<{$data->hours1}>" class="form-control input-width"  required/>
					<i class="ace-icon fa fa-clock-o green"></i>
				</span>
			</div>

			<div class="help-block inline"></div>
		</div>

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('logo')}></label>
			<input type="hidden" name="thumb" value="<{$data->thumb}>" />
			<div class="col-xs-12 col-sm-5">
				<div class="upfile_imgthumb">
					<img src="<{if $data->thumb}><{$data->thumb}><{else}>/style/xin_inselimg.png<{/if}>" data-default="/style/xin_inselimg.png" class="btn-upfile">
					<div class="upfile_imgcaption">
						<a href="javascript:;" class="btn btn-primary btn-xs btn-upfile"><{translate('アップロード')}></a>
						<a href="javascript:;" class="btn btn-default btn-xs btn-upremove"><{translate('削除する')}></a>
					</div>
				</div>
			</div>
			<div class="help-block inline"></div>
		</div>
		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('店舗名')}>*:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="nickname" type="text" name="nickname" value="<{$data->nickname}>" class="form-control input-width"  required/>
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>
		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('店舗タイプ')}>*:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<{foreach $item as $v}>
					<input type="checkbox" name="keywords[]" value="<{$v['title']}>" /><{$v['title']}>
					<{/foreach}>
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>


		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('連絡先')}>:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="name" type="text" name="name" value="" class="form-control input-width"  />
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>


		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('携帯番号')}>:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="phone" type="number" name="phone" value="<{$data->phone}>" class="form-control input-width"  />
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>

		<div class="form-group area2">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('都道府県')}>:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
						<select name="area1" id="area1" class="form-control input-width" >
										<{foreach $japan_city as $v}>
										<option value="<{$v['name']}>" <{if $data->area==$v['name']}>selected="selected"<{/if}> > <{$v['name']}></option>
							<{/foreach}>
									</select>
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('住所')}>:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="address" type="text" name="address" value="<{$data->address}>" class="form-control input-width"  required/>
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>
		
		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('緯度経度')}>:</label>
			<div class="col-xs-12 col-sm-2">
				<span class="block">
					<input id="lat" type="text" name="lat" value="" class="form-control input-width" required />
				</span>
			</div>
			<div class="col-xs-12 col-sm-2">
				<span class="block">
					<input id="lng" type="text" name="lng" value="" class="form-control input-width"  required/>
				</span>
			</div>
			<div class="col-xs-12 col-sm-1">
				<a href="javascript:;" class="btn-location btn btn-primary btn-sm"><{translate('現在地')}></a>
			</div>
			<div class="col-xs-12 col-sm-1">
				<div class="pull-right"></div><a href="javascript:;" class="btn-map btn btn-primary btn-sm"><{translate('店舗地図')}></a>
			</div>
			<div class="help-block inline">* <{translate('最初に住所を入力してください')}></div>
		</div>

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('口座名義')}>:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="compellation" type="text" name="compellation" value="<{$data->compellation}>" class="form-control input-width"  />
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('銀行名')}>:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="bank_name" type="text" name="bank_name" value="<{$data->bank_name}>" class="form-control input-width"  />
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('口座番号')}>:</label>
			<div class="col-xs-12 col-sm-5">
					<span class="block">
						<input id="bank_card" type="number" name="bank_card" value="<{$data->bank_card}>" class="form-control input-width"  />
					</span>
			</div>
			<div class="help-block inline"></div>
		</div>
            
		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('店舗紹介')}>:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<script id="editor" type="text/plain" style="width:620px;height:300px;"></script>
					<textarea id="text" name="text" style="display:none"><{$data->text}></textarea>
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>
             
			<div class="form-group">
				<div class="col-sm-offset-3 col-sm-9">
					<button type="button" id="saveedit" class="btn  btn-primary btn-lg"><{translate('確定')}></button>
				</div>
			</div>
		</form>
	</div>
</div>

<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.3&key=<{$geocoder_key}>&plugin=AMap.Geocoder"></script>

<script>
$(function () {
    $("#recmdid,#user_id").select2({
		ajax: {
			url: "/admin_user/search",
			data: function (params) {
				return { 
					keywords: params,
					bindmobile: $.trim($(this).data('bindmobile'))
				};
			},
			results:function(data,pageNo){
				if(data.data.length)data['data'].splice(0, 0, {'id':0, 'text': "<{translate('请选择')}>"});
				return {
					results:data.data	
				};
			},
			processResults: function (data) { 
				return {
					results: data
				};
			},
			type: 'post',
			dataType: 'json'
		},	
		initSelection: function(elem, cbfunc){
		},
		allowClear: false,
		openOnEnter: false,
		minimumInputLength: 1,
	});
	<{if $data->recmdid}>$('#recmdid').select2('data', {id:"<{$data->recmdid}>", text:"<{$data->recmdid_account}>"}).select2('val', ["<{$data->recmdid}>"]);<{/if}>
	<{if $data->user_id}>$('#user_id').select2('data', {id:"<{$data->user_id}>", text:"<{$data->userid_account}>"}).select2('val', ["<{$data->user_id}>"]);<{/if}>


    $("#corpid").select2({
		ajax: {
			url: "/admin_corp/search",
			data: function (params) {
				return { 
					keywords: params
				};
			},
			results:function(data,pageNo){
				if(data.data.length)data['data'].splice(0, 0, {'id':0, 'text': "<{translate('请选择')}>"});
				return {
					results:data.data	
				};
			},
			processResults: function (data) { 
				return {
					results: data
				};
			},
			type: 'post',
			dataType: 'json'
		},	
		initSelection: function(elem, cbfunc){
		},
		allowClear: false,
		openOnEnter: false,
		minimumInputLength: 1,
	});
	<{if $data->corpid}>$('#corpid').select2('data', {id:"<{$data->corpid}>", text:"<{$data->corpid_account}>"}).select2('val', ["<{$data->corpid}>"]);<{/if}>

            $('.city_type').change(function(){
                var city_type=$("input[name='city_type']:checked").val();;
                $(".area1").hide();
                $(".area2").hide();
                if(city_type==2){
                    $(".area2").show();
				}else {
                    $(".area1").show();
                }
            });
            $('.city_type').change();


});
</script>                        
<script type="text/javascript">
	var limitpercen=100;
	function limittxt(id){
        if(id==0) return true;
        $.post('/admin_corp/get_percen', { 'id': id }, function(res){
            var percen='' ;
            percen="<span> "+"<{translate('最大设置')}>"+res.data+" %</span>";
            $("#limit-percen").html(percen).change();
            limitpercen=parseFloat(res.data);
            return true;
        }, 'json').error(function(){
            tooltipbox.show("<{translate('数据或网络错误')}>");
        });
    }
function amap_click(map, res){
	console.log(res);
	//map.clearMap();
	$("#lng").val(res.lnglat.lng);
	$("#lat").val(res.lnglat.lat);
}
    function  formatminutes(date) {
        var aa = $(".laydate-time-list li ol")[1];
        var showtime = $($(".laydate-time-list li ol")[1]).find("li");
        for (var i = 0; i < showtime.length; i++) {
            var t00 = showtime[i].innerText;
            if (t00 != "00" && t00 != "20" && t00 != "30" && t00 != "40" && t00 != "50") {
                showtime[i].remove()
            }
        }
        $($(".laydate-time-list li ol")[2]).find("li").remove();  //清空秒

    }

$(document).ready(function() {
    $('#submitform').validate({
        errorElement: 'div',
        errorClass: 'help-block',
        focusInvalid: true,
        rules: {
            title: {
                required: true
            }
        }
    });
    laydate.render({
        elem: '#hours1',
        type: 'time'
        ,format: 'HH:mm'
        ,btns: ['clear', 'confirm']
        ,ready: formatminutes

    });
    laydate.render({
        elem: '#hours',
        type: 'time'
        ,format: 'HH:mm'
        ,btns: ['clear', 'confirm']
        ,ready: formatminutes
    });
    $('#corpid').change(function () {
        var corpid= $("#corpid").val();//代理商id
        if(corpid) limittxt(corpid);
    });
    $('.btn-map').click(function(){
			var address = $('#area').val() + ' ' + $('#address').val().replace(/ /g, '');
			address = address.replace(/^\s/g, '').replace(' ', '省');
			address = address.replace(' ', '市');
			$(this).prev().dialogBox({
				title:"<{translate('选择坐标')}>",
				fixTop: -1 * $(window).height() * 0.2,
				autoSize:false,
				hasMask:false,
				hasClose:true,
				width:Math.min(800, $(window).width() * 0.9),
				height:Math.min(600, $(window).height() * 0.9),
				frameborder:'no',
				scrolling:'auto',
				content:'/app/third_party/ueditor1_4_3_3-utf8-php/dialogs/map/map.html?address=' + encodeURI(encodeURI(address)),
				framedisplay:'none',
				iframeload:function(_iframe){
					$('#dialog-box-iframe').show(300);
					$('.dialog-box').dragDiv();
					//setTimeout(function(){ tooltipbox.clear(); }, 5000);
				},
				close:function(){					
				},
			});
			return false;	
		});
		var ue = UE.getEditor('editor', { autoFloatEnabled:false });
		ue.ready(function(){
			ue.setContent($('#text').val(), false);
		});
		//YYYY-MM-DD HH:mm:ss
		$('.datetimepicker').datetimepicker({
			format: 'YYYY-MM-DD',
			language: 'zh-CN',
			pickDate: true,
			pickTime: true,
			hourStep: 1,
			minuteStep: 15,
			secondStep: 30,
			inputMask: true
		});	
		$('#submitform').validate({
				errorElement : 'div',
				errorClass : 'help-block',
				focusInvalid : false,
				rules : {
				}
		});
		$('.check-adminname').click(function(){
			tooltipbox.show("<{translate('正在执行操作')}>");
			$.post('/admin_bguser/check', { 'id': "<{$data->id}>", 'adminname': $('#adminname').val() }, function(res){
				if(res.status == '0'){
					tooltipbox.alert("<{translate('账号可用')}>");
				}else if(res.status == '-1'){
					tooltipbox.alert("<{translate('未提交数据')}>");
				}else{
					tooltipbox.alert("<{translate('账号已经存在')}>");
				}
			}, 'json').error(function(){
				tooltipbox.show("<{translate('没有权限')}>");
			});
		});
		$("#saveedit").click(function() {
			 if ($('#submitform').valid()) {
			 	if($('#password').val()!=$('#repasswd').val())
			 	{
			 		alert("<{translate('两次输入的密码不一致')}>");
			 		return false;
			 	}
                 if($("#percen").val()>limitpercen){
                     tooltipbox.alert("<{translate('分成比例不能超过最大设置比例')}>"+limitpercen+"%");
                     return false;
                 }
                 if($('#hours').val() >$('#hours1').val()){
                     tooltipbox.alert("<{translate('结束营业时间不能小于开始营业时间')}>");
                     return false;
                 }


				//$('#text').val(ue.getContent());
				Dlc.service.post("/admin_shop/save_add/<{$qs_pid}>", $("#submitform").serialize());
				return false;
				//$('#submitform').submit();
			 }
		});
}); 
$('.btn-location').click(function(){
	if(!$('#area').val() || !$('#address').val()){
		tooltipbox.show("<{translate('都市を選択し、最初に詳細な住所を入力してください')}>");
		return false;
	}
    var map = new AMap.Map("container", {
        resizeEnable: true
    });
    var geocoder = new AMap.Geocoder({
            city: "", //城市，默认：“全国”
            radius: 500 //范围，默认：500
    });
	//地理编码
	geocoder.getLocation($('#area').val().replace(/ /g, '') + $('#address').val(), function(status, result) {
		if (status === 'complete' && result.info === 'OK') {
			//TODO:获得了有效经纬度，可以做一些展示工作
			//比如在获得的经纬度上打上一个Marker
			if(result.geocodes.length > 0){
				$('#lat').val(result.geocodes[0].location.lat);
				$('#lng').val(result.geocodes[0].location.lng);
			}
		}else{
			// 緯度と経度の取得に失敗
			tooltipbox.show("<{translate('失敗しました。住所が正しいことを確認してください。')}>");
		}
		//alert($.toJSON(result));
	});
});
</script>
 