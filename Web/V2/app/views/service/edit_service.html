<title>报障管理 - <{if $row['id']}>处理<{else}>添加<{/if}>报障 </title>
<div class="page-header">
	<h1>
		报障管理 <small> <i class="ace-icon fa fa-angle-double-right"></i> <{if $row['id']}>处理<{else}>添加<{/if}>报障
		</small>
	</h1>
</div>
<!-- /.page-header -->
	<script>window.UEDITOR_HOME_URL = '/app/third_party/ueditor1_4_3_3-utf8-php/';</script>
    <script type="text/javascript" charset="utf-8" src="/app/third_party/ueditor1_4_3_3-utf8-php/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="/app/third_party/ueditor1_4_3_3-utf8-php/ueditor.all.min.js"> </script>
    <script type="text/javascript" charset="utf-8" src="/app/third_party/ueditor1_4_3_3-utf8-php/lang/en/en.js"></script>
	<script type="text/plain" id="j_ueditorupload" style="height:5px;display:none;" ></script>
    <script type="text/javascript" charset="utf-8" src="/app/third_party/ueditor1_4_3_3-utf8-php/ueditor.upload.js"></script>

<div class="row">
	<div class="col-md-12">
<div class="main">
    <ul class="nav nav-tabs">
        <li><a href="/admin_system#page/admin_service/">报障列表</a></li>
        <li class="active"><a href="/admin_system#page/admin_service/edit/<{$row['id']}>"><{if $row['id']}>处理<{else}>添加<{/if}>报障</a></li>
    </ul>

  <div class="panel panel-default">
        <div class="panel-body table-responsive">
        
        		<form class="form-horizontal" role="form" id="submitform" action="/admin_service/edit/<{$row['id']}>" method="post" accept-charset="utf-8">
           
            
    <div class="form-group">
		<label class="col-xs-12 col-sm-3 control-label no-padding-right">类型:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
            	<input id="title" class="form-control input-width"  name="title" value="<{$row['title']}>" style="width:100%" readonly />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
    
       
   <!--  <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">服务编号*:</label>
		<div class="col-xs-12 col-sm-4">
			<span class="block">
				<input id="serviceno" name="serviceno" value="<{if $row['serviceno']}><{$row['serviceno']}><{else}><{getrandno()}><{/if}>" class="form-control input-width" required />
			</span>
		</div>
        <div class="col-xs-12 col-sm-1">
        <a href="javascript:;" class=" check-service btn  btn-primary btn-sm">检测重复</a>
        </div>
		<div class="help-block inline"></div>
	</div>-->
    
            
    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">会员*:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="user_id" name="user_id" class="form-control input-width" value="<{$row['user_id']}>" style="width:100%"  <{if $row['id']}>readonly<{/if}> />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>

    
     
    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">交易信息:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="trade_id" type="text" name="trade_id" value="<{$row['tradeid_tradeno']}>" style="width:100%" <{if $row['id']}>readonly<{/if}> />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
    
    <{if $row['id']}>
	<div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">商家信息:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input type="text" class="form-control input-width" value="<{$row['device_detail']['nickname']}>, <{$row['device_detail']['address']}>" disabled />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
    <{/if}>
    
	<div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">柜子编号:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="devicemacno" type="text" name="devicemacno" value="<{$row['devicemacno']}>" class="form-control input-width" <{if $row['id']}>disabled<{/if}> />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
    
    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">柜子格子:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="device_goodsdevicebox" type="text" name="device_goodsdevicebox" value="<{$row['device_goodsdevicebox']}>" class="form-control input-width" <{if $row['id']}>disabled<{/if}> />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
	
	<div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">护床编号1:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="device_goodsmacno" type="text" name="device_goodsmacno" value="<{$row['device_goodsmacno']}>" class="form-control input-width" <{if $row['id']}>disabled<{/if}> />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
    
    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">护床编号2:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="device_goodsmacno2" type="text" name="device_goodsmacno2" value="<{$row['device_goodsmacno2']}>" class="form-control input-width" <{if $row['id']}>disabled<{/if}> />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>

    <!--<div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">处理方式:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
                    <{foreach $service_action as $k => $v}>
                		<label><input type="radio" name="action" id="action" value="<{$k}>" <{if $row.action==$k}>checked<{/if}> /><{$v}></label>
                	<{/foreach}>
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
    
    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">处理费用:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="money" type="text" name="money" value="<{$row['money']}>" class="form-control input-width" />
			</span>
            <div class="help-block inline"> * 1)扣款将从会员余额扣除；2)退款退到会员余额；</div>
		</div>
	</div>-->

	<div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">反馈信息:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="cause" type="text" name="cause" value="<{$row['cause']}>" class="form-control input-width" />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
    
      
    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">添加日期:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="ctime" type="text" name="ctime" value="<{formattime($row['ctime'], 'Y-m-d H:i:s', formattime(time()))}>" class="form-control input-width datetimepicker" <{if $row['id']}>disabled<{/if}> />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
    
    <div class="form-group">
		<label class="col-xs-12 col-sm-3 control-label no-padding-right">状态:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
            	<select name="status" id="status" class="form-control">
                    <{foreach $service_status as $k => $v}>
                		<option value="<{$k}>" <{if $row.status==strval($k)}>selected<{/if}>><{$v}></option>
                	<{/foreach}>
                </select> 
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>

	<div class="form-group">
		<label class="col-xs-12 col-sm-3 control-label no-padding-right">反馈图片:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				   <{if $row['img']}>
						<{foreach explode("\n", str_replace("\r", "", $row['img'])) as $k => $v}>
							<img src="<{$v}>"  alt="" width="120" height="100"  >
						<{/foreach}>
					<{/if}>

			</span>
		</div>
		<div class="help-block inline"></div>
	</div>


    
            
			<div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">备注:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="memo" type="text" name="memo" value="<{$row['memo']}>" class="form-control input-width" />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
    
			 
			<div class="form-group">
				<div class="col-sm-offset-3 col-sm-9">
					<button type="button" id="saveedit" class="btn  btn-primary btn-lg">提交</button>
				</div>
			</div>
		</form>
        </div>
        </div>
	</div>
    </div>
</div>

<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.3&key=<{$geocoder_key}>&plugin=AMap.Geocoder"></script>
<script type="text/javascript">
var isbusy = false;

$(function(){
	<{if $row['id'] && $row['status'] == 1}>
		$('#submitform').find('input,select').prop('disabled', true);
		$('#submitform').find('input[name=memo]').prop('disabled', false);
	<{/if}>

	$('#submitform').validate({
			errorElement: 'div',
			errorClass: 'help-block',
			focusInvalid: true,
			rules: {
				title: {
					required: true
				}
			}
	});
	//YYYY-MM-DD HH:mm:ss
	$('.datetimepicker-date').datetimepicker({
		format: 'YYYY-MM-DD',
        language: 'zh-CN',
        pickDate: true,
        pickTime: false,
        hourStep: 1,
        minuteStep: 15,
        secondStep: 30,
        inputMask: true
	});
	//YYYY-MM-DD HH:mm:ss
	$('.datetimepicker').datetimepicker({
		format: 'YYYY-MM-DD HH:mm:ss',
        language: 'zh-CN',
        pickDate: true,
        pickTime: true,
        hourStep: 1,
        minuteStep: 15,
        secondStep: 30,
        inputMask: true
	});
	$('.check-service').click(function(){
		tooltipbox.show("<{translate('正在执行操作')}>");
		$.post('/admin_service/check', { 'id': "<{$row['id']}>", 'serviceno': $('#serviceno').val() }, function(res){
			if(res.status == '0'){
				tooltipbox.alert('服务编号未添加');
			}else if(res.status == '-1'){
				tooltipbox.alert('数据或网络错误');
			}else{
				tooltipbox.alert('服务编号已经存在');	
			}
		}, 'json').error(function(){
			tooltipbox.show('数据或网络错误');
		});
	});
	$('#saveedit').click(function(){
		if(!$('#submitform').valid())return false;
		if(isbusy)return false;
		isbusy = true;
		tooltipbox.show("<{translate('正在执行操作')}>");
		$.post('/admin_service/edit/<{$row['id']}>', $('#submitform').serialize(), function(res){
			if(res.status == '1'){
				tooltipbox.show(res.msg?res.msg:'操作完成');
				location.href = '/admin_system#page/admin_service/';
			}else if(res.status == '0'){
				tooltipbox.alert(res.msg?res.msg:'相同记录已经存在或者交易ID已经存在');
			}else{
				tooltipbox.show(res.msg?res.msg:'数据或网络错误');	
			}
			isbusy = false;
		}, 'json').error(function(a, b, c){
			tooltipbox.show('数据或网络错误');
			isbusy = false;
		});
	});
    $("#userid").select2({
		ajax: {
			url: "/admin_user/search",
			data: function (params) {
				return { 
					keywords: params,
				};
			},
			results:function(data,pageNo){
				return {
					results:data.data	
				};
			},
			processResults: function (data) { 
				return {
					results: data
				};
			},
			type: 'post',
			dataType: 'json'
		},		
		initSelection: function(elem, cbfunc){
		},
		allowClear: false,
		openOnEnter: false,
		minimumInputLength: 1,
	});
	<{if $row['userid']}>$('#userid').select2('data', {id:"<{$row['userid']}>", text:"<{$row['userid_account']}>"}).select2('val', ["<{$row['userid']}>"]);<{/if}>
	$('#userid').change(function(){
		$('#tradeid').select2('data', {id:"", text:""}).select2('val', [""]);
		$('#tradeid').change();
	});
    $("#tradeid").select2({
		ajax: {
			url: "/admin_trade/search",
			data: function (params) {
				return { 
					keywords: params,
					userid: $('#userid').val()
				};
			},
			results:function(data,pageNo){
				if(data.data.length){
					data['data'].splice(0, 0, {'id':'', 'text': '请选择'});
				}else{
					data['data'] = [{'id':'', 'text': '请选择'}];
				}
				return {
					results:data.data	
				};
			},
			processResults: function (data) { 
				return {
					results: data
				};
			},
			type: 'post',
			dataType: 'json'
		},		
		initSelection: function(elem, cbfunc){
		},
		allowClear: false,
		openOnEnter: false,
		minimumInputLength: 1,
	});
	<{if $row['tradeid']}>$('#tradeid').select2('data', {id:"<{$row['tradeid']}>", text:"<{$row['tradeid_tradeno']}>"}).select2('val', ["<{$row['tradeid']}>"]);<{/if}>
	/*$('#tradeid').change(function(){
		var tradeid = $(this).val();
		if(tradeid && tradeid != '0'){
			$('#devicemacno,#device_goodsmacno,#device_goodsmacno2').val('').prop('disabled', true);
		}else{
			$('#devicemacno,#device_goodsmacno,#device_goodsmacno2').prop('disabled', false);
		}
	});*/
});
</script> 