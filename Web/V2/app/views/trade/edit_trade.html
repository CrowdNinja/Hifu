<title><{translate('交易管理')}> - <{translate('订单详情')}> </title>
<div class="page-header">
	<h1>
		<{translate('交易管理')}> <small> <i class="ace-icon fa fa-angle-double-right"></i> <{translate('订单详情')}>
		</small>
	</h1>
</div>
<!-- /.page-header -->

<div class="row">
	<div class="col-md-12">
<div class="main">
    <ul class="nav nav-tabs">
        <li><a href="/admin_system#page/admin_trade/"><{translate('交易列表')}></a></li>
        <li class="active"><a href="/admin_system#page/admin_trade/edit/<{$row['id']}>"><{translate('订单详情')}></a></li>
    </ul>

  <div class="panel panel-default">
        <div class="panel-body table-responsive">
        
        		<form class="form-horizontal" role="form" id="submitform" action="/admin_trade/edit/<{$row['id']}>" method="post" accept-charset="utf-8">
           
            
            <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('交易号')}>:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="tradeno" name="tradeno" value="<{$row['tradeno']}>" class="form-control input-width" readonly />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>

					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('支付流水号')}>:</label>
						<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="tran_id" name="tran_id" value="<{$row['tran_id']}>" class="form-control input-width" readonly />
			</span>
						</div>
						<div class="help-block inline"></div>
					</div>

		<div class="form-group">
			<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('代理商')}>:</label>
			<div class="col-xs-12 col-sm-5">
				<span class="block">
					<input id="corp_account" name="corp_account" value="<{$row['corp_account']}>" class="form-control input-width " readonly />
				</span>
			</div>
			<div class="help-block inline"></div>
		</div>

    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('商家')}>:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="admin_account" name="admin_account" value="<{$row['admin_account']}>" class="form-control input-width " readonly />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>



    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('会员')}>:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="user_account" name="user_account" value="<{$row['user_account']}>" class="form-control input-width " readonly />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>

    
    <!--<div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right">设备编号:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="device_macno" name="device_macno" value="<{$row['device_macno']}>" class="form-control input-width " readonly />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>-->




 	<div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('支付方式')}>:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
            	<select name="paytype" id="paytype" class="form-control" disabled="disabled">
               		<{foreach $trade_paytype as $k => $v}>                 
                		<option value="<{$k}>" <{if strval($row['paytype'])==strval($k)}>selected<{/if}>><{$v}></option>
                	<{/foreach}>
                    
                </select> 
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
             
    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('支付时间')}>:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="paytime" type="text" name="paytime" value="<{$row['paytime']}>" class="form-control input-width " readonly />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
             
    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('创建时间')}>:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="ctime" type="text" name="ctime" value="<{$row['ctime']}>" class="form-control input-width " readonly />
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>

    
    <div class="form-group">
		<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('交易状态')}>:</label>
		<div class="col-xs-12 col-sm-5">
			<span class="block">
            	<input type="hidden" name="_status" value="<{$row['status']}>"/>
            	<select name="status" id="status" class="form-control"  disabled="disabled"  >
               		<{foreach $trade_status as $k => $v}>                 
                		<option value="<{$k}>" <{if strval($row['status'])==strval($k)}>selected<{/if}>><{$v}></option>
                	<{/foreach}>
                    
                </select> 
			</span>
		</div>
		<div class="help-block inline"></div>
	</div>
					<{if $row['status']<0}>
					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('退款时间')}>:</label>
						<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="refund_time" type="text" name="refund_time" value=" <{$row['refund_time']}>" class="form-control input-width " readonly />
			</span>
						</div>
						<div class="help-block inline"></div>
					</div>
					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('退款原因')}>:</label>
						<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="refund_cause" type="text" name="refund_cause" value="<{$row['refund_cause']}>" class="form-control input-width " readonly />
			</span>
						</div>
						<div class="help-block inline"></div>
					</div>
					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('退款备注')}>:</label>
						<div class="col-xs-12 col-sm-5">
			<span class="block">
				<textarea id="refund_memo" type="text" name="refund_time"  class="form-control input-width " > <{$row['refund_memo']}></textarea>
			</span>
						</div>
						<div class="help-block inline"></div>
					</div>
					<{/if}>

					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('到期时间')}>:</label>
						<div class="col-xs-12 col-sm-5">
			<span class="block">
				<input id="end_time" type="text" name="end_time" value="<{$row['end_time']}>" class="form-control input-width " readonly />
			</span>
						</div>
						<div class="help-block inline"></div>
					</div>

					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('套餐信息')}>:</label>
						<div class="col-xs-12 col-sm-5">
							<div class="panel-heading" onclick="$(this).parent().find('.panel-body').toggle()"><i class="glyphicon glyphicon-chevron-down"></i> <{translate('查看')}></div>
							<div class="panel-body" style="display:none">
							<span class="block">
								<span class="label label-success arrowed-in arrowed-in-right" style="margin: 0 0 2px"><{translate('套餐名称')}>：<{$row['pack']['title']}> </span><br/>
								<span class="label label-pink arrowed-in arrowed-in-right" style="margin: 0 0 2px"><{translate('套餐金额')}>：<{$row['pack']['price']}>元</span> <br/>
								<table class="table table-bordered table-hover">
						<thead>
							<tr>
								<th><{translate('ID')}></th>
								<th><{translate('项目名称')}></th>
								<th><{translate('次数')}></th>
								<th><{translate('刀数')}></th>
								<th><{translate('已使用次数')}></th>
							</tr>
						</thead>
						<tbody>
							<{foreach $row['trade_pack'] as $v}>
							<tr class="alert1 success" align="left">
								<td><{$v['id']}></td>
								<td><{$v['item_name']}></td>
                                <td><{$v['num']}> <{translate('次')}></td>
                                <td><{$v['knife']}> <{translate('刀')}></td>
                                <td><{$v['use_num']}> <{translate('次')}></td>
							</tr>
							<{/foreach}>
						</tbody>
					</table>
							</span>
							</div>
						</div>
						<div class="help-block inline"></div>
					</div>

					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('订单总金额')}>:</label>
						<div class="col-xs-12 col-sm-5">
							<span class="block">
								<input id="money" type="text" name="money" value="<{$row['money']}> <{translate('元')}>" class="form-control input-width " readonly />
							</span>
						</div>
						<div class="help-block inline"></div>
					</div>
					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"> <{translate('优惠金额')}>:</label>
						<div class="col-xs-12 col-sm-5">
							<span class="block">
								<input id="discount" type="text" name="discount" value="<{$row['discount']}> <{translate('元')}>" class="form-control input-width " readonly />
							</span>
						</div>
						<div class="help-block inline"></div>
					</div>

					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('实付金额')}>:</label>
						<div class="col-xs-12 col-sm-5">
							<span class="block">
								<input id="pay_money" type="text" name="pay_money" value="<{$row['pay_money']}> <{translate('元')}>" class="form-control input-width " readonly />
							</span>
						</div>
						<div class="help-block inline"></div>
					</div>

					<{if $row['status']>2}>
					<div class="form-group">
						<label for="title" class="col-xs-12 col-sm-3 control-label no-padding-right"><{translate('分成信息')}>：</label>
						<div class="col-xs-12 col-sm-5">
							<{if $divide_record}>
							<{foreach $divide_record as $k=>$v}>
							<{translate('收益人')}>：<b><{$v['agentname']}> - <{$v['parameter_id']}></b><br/>
							<{translate('收益金额')}>：<b><{$v['money']}></b> <{translate('元')}><br/>
							<{translate('分成比例')}>：<b><{$v['proportion']}></b> %<br/><br/>
							<{/foreach}>
							<{else}>
							<{translate('无')}>
							<{/if}>

						</div>
						<div class="help-block inline"></div>
					</div>
					<{/if}>


			 
			<div class="form-group">
				<div class="col-sm-offset-3 col-sm-9">
					<a href="/admin_system#page/admin_trade?page=<{$page}>" class="btn btn-primary btn-lg"><{translate('返回')}></a>
					<{if chkcommand('/admin_trade/refund')}>
					<{if in_array($row['status'],['-1','3','4'])}>
					<a href="javascript:;" class="btn btn-danger btn-lg  " id="refund" data-id="<{$row['id']}>"> <i class="fa fa-rmb"></i> <{translate('退款')}></a>
					<{/if}>
					<{/if}>
				</div>
			</div>
		</form>
        </div>
        </div>
	</div>
    </div>
</div>

<script type="text/javascript">
var isbusy = false;

$(function(){
	$('#submitform').validate({
			errorElement: 'div',
			errorClass: 'help-block',
			focusInvalid: true,
			rules: {
				title: {
					required: true
				}
			}
	});
    $('#refund').click(function(){
        var id = $(this).data('id');

        tooltipbox.confirm("<{translate('确定要退款？')}>", function(data){
            tooltipbox.show("<{translate('正在执行操作')}>");
            $.post('/admin_trade/refund', data, function(res){
                if(res.status == '1'){
                    tooltipbox.show("<{translate('操作执行成功')}>");
                    location.reload();
                }else{
                    tooltipbox.show(res.msg);
                }
            }, 'json').error(function(){
                tooltipbox.show("<{translate('数据或网络错误')}>");
            });
        }, false, { 'id': id });
    });
    $('#finish_order').click(function(){
        var id = $(this).data('id');

        tooltipbox.confirm('确定要结束订单？', function(data){
            tooltipbox.show("<{translate('正在执行操作')}>");
            $.post('/admin_trade/finish_order', data, function(res){
                if(res.status == '1'){
                    tooltipbox.show("<{translate('操作执行成功')}>");
                    location.reload();
                }else{
                    tooltipbox.show(res.msg);
                }
            }, 'json').error(function(){
                tooltipbox.show("<{translate('数据或网络错误')}>");
            });
        }, false, { 'id': id });
    });
    $( "#use_time" ).tooltip({
        hide: {
            effect: "slideDown",
            delay: 250
        }
    });

	$('#saveedit').click(function(){
		if(!$('#submitform').valid())return false;
		if(isbusy)return false;
		isbusy = true;
		tooltipbox.show("<{translate('正在执行操作')}>");
		$.post('/admin_trade/edit/<{$row['id']}>', $('#submitform').serialize(), function(res){
			if(res.status == '1'){
				tooltipbox.show(res.msg ? res.msg : '操作完成');
				//location.href = '/admin_system#page/admin_trade/';
				history.back(-1);
			}else if(res.status == '0'){
				tooltipbox.alert(res.msg ? res.msg : '交易号重复了');	
			}else{
				tooltipbox.show(res.msg ? res.msg : "<{translate('数据或网络错误')}>");
			}
			isbusy = false;
		}, 'json').error(function(a, b, c){
			tooltipbox.show("<{translate('数据或网络错误')}>");
			isbusy = false;
		});
	});
});
</script> 